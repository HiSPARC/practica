<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
    <head>
        <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="scripts/excanvas.js"></script><![endif]-->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
        <script type="text/javascript" src="scripts/jquery-1.10.2.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <link rel="stylesheet" href="/resources/demos/style.css" />
        <script>
        
            var kMax = 0;
            var hours = ['00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24'];
            var events = new Array();
            var coinc = new Array();
            var station = new Array();
            var url = new Array;
            var year = 2013;
            var month = 01;
            var day = 02;
            var hour = 01;
            station[0]='102';
            station[1]='104';
            station[2]='105';
            station[3]='103';
            station[4]='508';
            station[5]='501';
            station[6]='502';
            
            function padZero(number, length) {
                var str = '' + number;
                while (str.length < length) {
                    str = '0' + str;}
                return str;
            }
                    
            function getData(URL, j) {
                    $.get(URL,function(data){
                    var event = new Array();
                    var dataStr = new String(data); // parsed data als string
                    var record = dataStr.split('\n'); // maakt een array met records
                    for(i = 0; i < record.length; i++){ // verwijdert commentaar regels
                        if(record[0].substr(0,1) == "#") {
                            record.splice(0,1);
                            i = i-1;
                        }
                    }
                    for(i = 0; i < record.length; i++){
                        event[i] = record[i].split('\t'); // maakt een 2d array met event informatie
                    }
                    events[j] = event; // maakt een 3 d array met eventsidentie informatie
                    kMax += event.length-1;
//                    alert(kMax + ', ' + event.length);
                    j++
                    if(j < station.length) { 
                        getData(url[j], j)
                    }
                    else {
                        var first, firstTime;
                        var output = '<table border = "1"><tr><th>station</th><th>event time</th>';
                        for(k = 0; k < kMax; k++)     {
                            first = 0;
                            firstTime = '23:59:59:999999999';
                            for(i = 0; i < station.length; i++){
                                events[i][0][3] = padZero(events[i][0][3], 9);
                                time = events[i][0][1] + ':' + events[i][0][3];
                                if(time < firstTime){
                                    firstTime = time; 
                                    first = i;
                                }
                            }
                            coinc[k] = events[first][0];
                            coinc[k].unshift(station[first]);
                            events[first].splice(0,1);
                            output += '</tr><tr><td>' + coinc[k][0] + '</td><td>' + coinc[k][2] + ':'+ coinc[k][4] + '</td>';
                        }
                        output += '</tr></table>';
                        $( "#CSVTable" ).append( output );
                    }
                });
            }
            
            $(function() {
                var date = '2013-07-25';
                var time = '00';
                for(i = 0; i < station.length; i++){
                    url[i] = 'http://data.hisparc.nl/data/' + station[i] + '/events?start=' + date + '+'+time+':00:00&end=' + date + '+01:00:00';    
                }
                $('#datepicker').datepicker({ dateFormat: 'yy-mm-dd' }).val();
                $('#stations').menu();
                var hour;
                $( "#loadEvents" ).click(function() {
                    var hour = $('#hourpicker :selected').val();
                    var startTime = hours[hour];
                    hour++;
                    var stopTime = hours[hour]
                    date = $('#datepicker').val();
                    for(i = 0; i < station.length; i++){
                        url[i] = 'http://data.hisparc.nl/data/' + station[i] + '/events?start=' + date + '+'+startTime+':00:00&end=' + date + '+'+stopTime+':00:00';    
                    }
                    getData(url[0], 0);
                });
            });
        </script>
        <style>
            .ui-menu { width: 250px; }
        </style>
    </head>
    <body>
        <p>Date: 
            <input type="text" id="datepicker" />
            Time: 
            <select id="hourpicker">
                <option value="0" text="iug">00 / 01</option>
                <option value="1">01 / 02</option>
                <option value="2">02 / 03</option>
                <option value="3">03 / 04</option>
                <option value="4">04 / 05</option>
                <option value="5">05 / 06</option>
                <option value="6">06 / 07</option>
                <option value="7">07 / 08</option>
                <option value="8">08 / 09</option>
                <option value="9">09 / 10</option>
                <option value="10">10 / 11</option>
                <option value="11">11 / 12</option>
                <option value="12">12 / 13</option>
                <option value="13">13 / 14</option>
                <option value="14">14 / 15</option>
                <option value="15">15 / 16</option>
                <option value="16">16 / 17</option>
                <option value="17">17 / 18</option>
                <option value="18">18 / 19</option>
                <option value="19">19 / 20</option>
                <option value="20">20 / 21</option>
                <option value="21">21 / 22</option>
                <option value="22">22 / 23</option>
                <option value="23">23 / 24</option>
           </select> 
           <input type="button" id="loadEvents" value="Load events" />
        </p>
        <ul id="stations">
            <li><a href="#">Amsterdam</a>
                <ul>
                    <li>2 St. Nicolaaslyceum</li>
                    <li>3 Het Amsterdams Lyceum</li>
                    <li>5 CSG Buitenveldert</li>
                    <li>6 Damstede</li>
                    <li>5 CSG Buitenveldert</li>
                    <li>7 Joke Smit College</li>
                    <li>9 Vrije Universiteit</li>
                    <li>10 Herman Wesselink Coll.</li>
                </ul>
            </li>
            <li><a href="#">Alkmaar</a>
                <ul>
                    <li>401 Willem Blaeu</li>
                    <li>402 Jan Arentz</li>
                </ul>
            </li>
            <li><a href="#">Haarlem</a>
                <ul>
                    <li>Coornhert Lyceum</li>
                </ul>
            </li>
            <li><a href="#">Hoorn</a>
                <ul>
                    <li"><a href="#">Werenfridus</a></li>
                </ul>
            </li>
            <li><a href="#">Kennemerland</a>
                <ul>
                    <li>301 Jac. P. Thijsse</li>
                    <li>302 Bonhoeffer / UvA</li>
                </ul>
            </li>
        </ul>
        <div id="CSVTable"></div>
    </body>
</html>